{"version":3,"file":"notes.js","sources":["pages/notes/notes.vue","../../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvbm90ZXMvbm90ZXMudnVl"],"sourcesContent":["<template>\n  <view class=\"container\">\n    <uni-search-bar\n      @confirm=\"search\"\n      :focus=\"true\"\n      radius=\"30\"\n      bgColor=\"#fff\"\n      placeholder=\"输入笔记标题\"\n      v-model=\"searchValue\"\n      @blur=\"blur\"\n      @focus=\"focus\"\n      @input=\"input\"\n      @cancel=\"cancel\"\n      @clear=\"clear\"\n    >\n    </uni-search-bar>\n\n    <!-- 内容滚动区域 -->\n    <scroll-view\n      ref=\"scrollView\"\n      class=\"content-scroll\"\n      scroll-y\n      @scrolltolower=\"handleScrollToLower\"\n      :refresher-triggered=\"triggered\"\n      @refresherrefresh=\"onRefresh\"\n      @refresherpulling=\"onPulling\"\n      refresher-enabled=\"true\"\n      lower-threshold=\"200\"\n    >\n      <view v-if=\"notes.length === 0 && !isLoading\" class=\"empty-state\">\n        <image class=\"empty-icon\" src=\"/static/logo.png\"></image>\n        <text class=\"empty-text\">{{\n          searchValue ? \"未找到相关笔记\" : \"暂无笔记\"\n        }}</text>\n        <text class=\"empty-subtext\">\n          {{\n            searchValue\n              ? \"尝试调整搜索关键词\"\n              : \"点击右下角添加按钮创建第一条笔记\"\n          }}\n        </text>\n      </view>\n      <view v-else>\n        <view\n          v-for=\"(note, index) in notes\"\n          :key=\"note.id\"\n          class=\"note-item\"\n          @tap=\"viewNoteDetail(note.id)\"\n        >\n          <view class=\"note-header\">\n            <text class=\"note-title\">{{ note.title }}</text>\n          </view>\n          <view class=\"note-label\">\n            <uni-tag\n              class=\"note-tag\"\n              circle\n              customStyle=\"background-color: #e6eaff;color:#4A6CF7;border:none\"\n              :text=\"tag.name\"\n              v-for=\"(tag, tagIndex) in note.tags\"\n              :key=\"tag.id\"\n              type=\"primary\"\n            ></uni-tag>\n          </view>\n          <text class=\"note-content\">{{\n            truncateText(note.content, 100)\n          }}</text>\n          <view class=\"note-footer\">\n            <text class=\"note-date\">{{ formatDate(note.createdAt) }}</text>\n          </view>\n        </view>\n      </view>\n\n      <!-- 使用uni-load-more组件实现加载更多 -->\n      <view v-if=\"notes.length > 0\" class=\"load-more-container\">\n        <uni-load-more\n          :status=\"loadMoreStatus\"\n          :content-text=\"{\n            contentdown: '下滑加载更多',\n            contentrefresh: '加载中...',\n            contentnomore: '没有更多数据了',\n          }\"\n        ></uni-load-more>\n      </view>\n    </scroll-view>\n\n    <!-- 添加笔记浮动按钮 -->\n    <view class=\"add-btn\" @tap=\"addNote\">\n      <text class=\"add-btn-text\">+</text>\n    </view>\n  </view>\n</template>\n\n<script>\n// 导入笔记API\nimport { getNoteList } from \"../../api/note\";\n// 导入存储工具函数\nimport { getUserId } from \"../../utils/storage\";\n\nexport default {\n  data() {\n    return {\n      notes: [],\n      isLoading: false,\n      triggered: false,\n      currentPage: 1,\n      pageSize: 10,\n      hasMore: true,\n      searchValue: \"\", // 搜索关键词\n      debounceTimer: null, // 防抖定时器\n      loadMoreStatus: \"more\", // 加载更多状态：more(可以加载更多), loading(加载中), noMore(没有更多数据)\n    };\n  },\n  // 页面加载时执行\n  onLoad() {\n    this.loadNotes();\n  },\n\n  // 监听滚动到底部事件\n  handleScrollToLower() {\n    // 当滚动到底部且没有在加载中且有更多数据时，触发加载\n    if (!this.isLoading && this.hasMore) {\n      this.loadNotes();\n    }\n  },\n  methods: {\n    // 下拉刷新处理函数\n    onRefresh() {\n      // 重置页码为第一页\n      this.currentPage = 1;\n      this.hasMore = true;\n      // 重新获取数据\n      this.loadNotes().then(() => {\n        // 数据加载完成后，停止下拉刷新动画\n        uni.stopPullDownRefresh();\n      });\n      // this.hasMore = true;\n      // this.triggered = true;\n      // if (!this.isPull) {\n      //   this.isPull = true; //下拉加载，先让其变true再变false才能关闭\n      //   //关闭加载状态 (转动的圈)，需要一点延时才能关闭\n      //   // 重新加载数据\n      //   this.loadNotes().finally(() => {\n      //     // 停止下拉刷新动画\n      //     console.log(\"停止加载\");\n      //     this.triggered = false;\n      //   });\n      // }\n    },\n    onPulling() {\n      var that = this;\n      if (!this.triggered) {\n        //下拉加载，先让其变true再变false才能关闭\n        this.triggered = true;\n        //关闭加载状态 (转动的圈)，需要一点延时才能关闭\n        setTimeout(() => {\n          that.triggered = false;\n        }, 1000);\n      }\n    },\n\n    // 加载笔记列表\n    async loadNotes() {\n      // 如果已经没有更多数据，直接返回\n      if (!this.hasMore) return;\n\n      this.isLoading = true;\n      this.loadMoreStatus = \"loading\"; // 设置加载状态\n      try {\n        const query = {\n          currentPage: this.currentPage,\n          pageSize: this.pageSize,\n          title: this.searchValue, // 添加搜索条件\n          userId: getUserId(), // 添加userId参数\n        };\n\n        // 调用真实的API\n        const res = await getNoteList(query);\n\n        console.log(\"笔记列表API返回:\", res);\n\n        // 根据新的返回格式，数据在data.records数组中\n        const records = res.data && res.data.records ? res.data.records : [];\n\n        // 将API返回的数据转换为页面需要的格式\n        const newNotes = records.map((note) => {\n          // 解析标签字符串为数组并与标签名称合并为对象数组\n          const tagIds = note.tagId\n            ? note.tagId.split(\",\").map((id) => parseInt(id.trim()))\n            : [];\n          const tagNames = note.tagNames || [];\n\n          // 创建包含id和name属性的标签对象数组\n          const tags = tagIds.map((id, index) => ({\n            id: id,\n            name: tagNames[index] || \"未命名标签\",\n          }));\n\n          return {\n            id: note.noteId,\n            title: note.title,\n            content: this.cleanHtmlContent(note.content),\n            createdAt: new Date(note.createTime).getTime(),\n            updatedAt: new Date(note.updateTime).getTime(),\n            tags: tags,\n            tagNames: tagNames, // 保留原始标签名称数组，兼容模板使用\n          };\n        });\n\n        // 如果是第一页，替换数据；否则追加数据\n        if (this.currentPage === 1) {\n          this.notes = newNotes;\n        } else {\n          this.notes = [...this.notes, ...newNotes];\n        }\n\n        // 判断是否还有更多数据\n        const total = res.data && res.data.total ? res.data.total : 0;\n        this.hasMore = this.notes.length < total;\n\n        // 如果有更多数据，增加页码\n        if (this.hasMore) {\n          this.currentPage++;\n        }\n      } catch (error) {\n        console.error(\"加载笔记列表失败:\", error);\n        uni.showToast({\n          title: \"加载失败，请重试\",\n          icon: \"none\",\n        });\n        this.loadMoreStatus = \"more\"; // 加载失败时恢复为可加载状态\n      } finally {\n        this.isLoading = false;\n        // 根据是否有更多数据更新状态\n        this.loadMoreStatus = this.hasMore ? \"more\" : \"noMore\";\n      }\n    },\n\n    // 清理HTML内容，只保留文本\n    cleanHtmlContent(html) {\n      if (!html) return \"\";\n\n      // 简单的HTML标签去除\n      const text = html.replace(/<[^>]+>/g, \"\");\n      // 去除多余的空白字符\n      return text.replace(/\\s+/g, \" \").trim();\n    },\n\n    // 查看笔记详情\n    viewNoteDetail(noteId) {\n      uni.navigateTo({\n        url: `/pages/notes/note-detail?id=${noteId}`,\n      });\n    },\n\n    // 添加笔记\n    addNote() {\n      uni.navigateTo({\n        url: \"/pages/notes/add-note\",\n      });\n    },\n\n    // 搜索相关方法\n    search() {\n      // 重置页码和数据\n      this.currentPage = 1;\n      this.hasMore = true;\n      // 重新加载数据\n      this.loadNotes();\n    },\n\n    // 输入时触发 - 实现防抖搜索\n    input() {\n      // 清除之前的定时器\n      if (this.debounceTimer) {\n        clearTimeout(this.debounceTimer);\n      }\n\n      // 设置新的定时器，延迟500ms执行搜索\n      this.debounceTimer = setTimeout(() => {\n        // 重置页码和数据\n        this.currentPage = 1;\n        this.hasMore = true;\n        // 重新加载数据\n        this.loadNotes();\n      }, 500);\n    },\n\n    // 聚焦时触发\n    focus() {\n      // 可选：聚焦时的处理\n    },\n\n    // 失焦时触发\n    blur() {\n      // 可选：失焦时的处理\n    },\n\n    // 取消搜索\n    cancel() {\n      this.searchValue = \"\";\n      // 重置页码和数据\n      this.currentPage = 1;\n      this.hasMore = true;\n      // 重新加载数据\n      this.loadNotes();\n    },\n\n    // 清空搜索内容\n    clear() {\n      this.searchValue = \"\";\n      // 重置页码和数据\n      this.currentPage = 1;\n      this.hasMore = true;\n      // 重新加载数据\n      this.loadNotes();\n    },\n\n    // 格式化日期\n    formatDate(timestamp) {\n      const date = new Date(timestamp);\n      const year = date.getFullYear();\n      const month = String(date.getMonth() + 1).padStart(2, \"0\");\n      const day = String(date.getDate()).padStart(2, \"0\");\n      return `${year}-${month}-${day}`;\n    },\n\n    // 截断文本\n    truncateText(text, maxLength) {\n      if (text.length <= maxLength) return text;\n      return text.substring(0, maxLength) + \"...\";\n    },\n  },\n};\n</script>\n\n<style>\n.container {\n  height: 100vh;\n  background-color: #f8faff;\n  display: flex;\n  flex-direction: column;\n}\n\n/* 内容滚动区域 */\n.content-scroll {\n  flex: 1;\n  height: calc(100vh - 100rpx);\n  overflow-y: auto;\n}\n\n/* 导航栏样式 */\n.header {\n  display: flex;\n  flex-direction: column;\n  align-items: stretch;\n  padding: 20rpx 30rpx;\n  background-color: #ffffff;\n  box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);\n  position: sticky;\n  top: 0;\n  z-index: 10;\n}\n\n.header-title {\n  font-size: 36rpx;\n  font-weight: bold;\n  color: #333333;\n  margin-bottom: 20rpx;\n}\n\n.header-actions {\n  display: flex;\n  align-items: center;\n}\n\n.header-icon {\n  width: 48rpx;\n  height: 48rpx;\n  margin-left: 40rpx;\n}\n\n/* 笔记列表样式 */\n.notes-list {\n  padding: 20rpx;\n}\n\n.note-item {\n  background-color: #ffffff;\n  border-radius: 16rpx;\n  padding: 30rpx;\n\n  margin: 0 20rpx;\n  margin-bottom: 20rpx;\n  box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.05);\n  transition: transform 0.2s;\n}\n\n.note-item:active {\n  transform: scale(0.98);\n}\n\n.note-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 20rpx;\n}\n\n.note-title {\n  font-size: 32rpx;\n  font-weight: bold;\n  color: #333333;\n  flex: 1;\n}\n\n.note-date {\n  font-size: 24rpx;\n  color: #999999;\n  margin-left: 20rpx;\n}\n\n.note-content {\n  font-size: 28rpx;\n  color: #666666;\n  line-height: 44rpx;\n  margin-bottom: 20rpx;\n  overflow-x:hidden;\n  text-overflow: ellipsis;\n}\n\n.note-label {\n  display: flex;\n  flex-wrap: wrap;\n}\n.note-tag {\n  margin: 0 12rpx 25rpx 0;\n}\n.note-footer {\n  display: flex;\n  justify-content: flex-end;\n}\n\n.note-tags {\n  font-size: 24rpx;\n  color: #4a6cf7;\n  background-color: #e8efff;\n  padding: 6rpx 16rpx;\n  border-radius: 16rpx;\n  margin-right: 12rpx;\n  margin-bottom: 12rpx;\n}\n\n/* 空状态样式 */\n.empty-state {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  padding: 100rpx 0;\n}\n\n.empty-icon {\n  width: 200rpx;\n  height: 200rpx;\n  opacity: 0.5;\n  margin-bottom: 30rpx;\n}\n\n.empty-text {\n  font-size: 32rpx;\n  color: #666666;\n  margin-bottom: 16rpx;\n}\n\n.empty-subtext {\n  font-size: 26rpx;\n  color: #999999;\n  text-align: center;\n  padding: 0 60rpx;\n}\n\n/* 添加按钮样式 */\n.add-btn {\n  position: fixed;\n  right: 40rpx;\n  bottom: 40rpx;\n  width: 100rpx;\n  height: 100rpx;\n  border-radius: 50%;\n  background-color: #4a6cf7;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  box-shadow: 0 4rpx 20rpx rgba(74, 108, 247, 0.4);\n}\n\n.add-btn-text {\n  font-size: 60rpx;\n  color: #ffffff;\n  line-height: 1;\n  margin-top: -8rpx;\n}\n\n/* 加载更多容器样式 */\n.load-more-container {\n  padding: 20rpx 0 30rpx;\n  display: flex;\n  justify-content: center;\n}\n</style>\n","import MiniProgramPage from 'D:/programming/Uniapp/aiNote/pages/notes/notes.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","getUserId","getNoteList"],"mappings":"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"}